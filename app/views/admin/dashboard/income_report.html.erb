<!-- app/views/admin/dashboard/income_report.html.erb -->
<div class="container bg-light text-black">
  <h1 class="mb-4">Reporte de Ingresos</h1>

  <!-- Gran Total de Ingresos -->
  <div class="card mb-4">
    <div class="card-header">Gran Total de Ingresos</div>
    <div class="card-body">
      <h2 class="text-success">$<%= number_to_currency(@total_income, precision: 2) %></h2>
    </div>
  </div>

  <!-- Ingresos por Workshop -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white">Ingresos por Workshop</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead class="thead-light">
            <tr>
              <th>Workshop</th>
              <th>Ingresos</th>
            </tr>
          </thead>
          <tbody>
            <% if @income_by_workshop.present? %>
              <% @income_by_workshop.each do |income_info| %>
                <tr>
                  <td><%= income_info[:workshop].name %></td>
                  <td class="text-right font-weight-bold">$<%= number_to_currency(income_info[:income], precision: 2) %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="2">No data available.</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <canvas id="incomeByWorkshopChart"></canvas> <!-- Always render the canvas -->
    </div>
  </div>

  <!-- Ingresos por Classroom -->
  <div class="card">
    <div class="card-header bg-secondary text-white">Ingresos por Classroom</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead class="thead-light">
            <tr>
              <th>Classroom</th>
              <th>Ingresos</th>
            </tr>
          </thead>
          <tbody>
            <% if @income_by_classroom.present? %>
              <% @income_by_classroom.each do |classroom_info| %>
                <tr>
                  <td>Aula <%= classroom_info[:classroom].id %></td>
                  <td class="text-right font-weight-bold">$<%= number_to_currency(classroom_info[:income], precision: 2) %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="2">No classroom data available.</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var ctxWorkshop = document.getElementById('incomeByWorkshopChart');
    if (ctxWorkshop && <%= @workshops.present? %>) {
      var incomeByWorkshopChart = new Chart(ctxWorkshop.getContext('2d'), {
        type: 'bar',
        data: {
          labels: <%= @workshops.map { |w| w[:name] }.to_json.html_safe %>,
          datasets: [{
            label: 'Ingresos por Workshop',
            data: <%= @workshops.map { |w| w[:income] }.to_json.html_safe %>,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    } else {
      console.log('No data available or no canvas element found for the workshop chart');
    }
  });
</script>
